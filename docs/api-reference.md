# API Reference

> Auto-generated by `node scripts/generate-docs.js` on 2026-02-10
> Do not edit manually — regenerate from source.

---

## Library Modules (`scripts/quality/lib/`)

### animation-detector.js (751 lines)

**Called by:** extract-reference.js, test-animation-detector.js, url-to-preset.js

**Exports:** `getPreNavigationScript`, `setupNetworkInterception`, `getMutationObserverScript`, `extractAnimationData`, `analyzeAnimationEvidence`, `groupAnimationsBySection`

#### Exported Functions

##### `getPreNavigationScript()` <sub>line 16</sub>

Returns a JS string for page.addInitScript() that monkey-patches

- **Returns:** `string` Script source to inject pre-navigation

##### `setupNetworkInterception(page)` <sub>line 174</sub>

Attaches a response handler to a Playwright page that collects animation-

- **page** `import('playwright').Page` — Playwright page instance

- **Returns:** `Promise<Function>` Getter that returns collected network results

##### `getMutationObserverScript()` <sub>line 217</sub>

Returns a JS string to inject via page.evaluate() after page load but

- **Returns:** `string` Script source to inject post-load

##### `extractAnimationData(page)` <sub>line 256</sub>

Collects animation evidence from the page via page.evaluate(). Detects

- **page** `import('playwright').Page` — Playwright page instance

- **Returns:** `Promise<Object>` Raw animation evidence from the page

##### `analyzeAnimationEvidence(evidence, networkResults, sections, renderedDOM)` <sub>line 448</sub>

Pure analysis function (no browser access). Scores animation intensity,

- **evidence** `Object` — Output from extractAnimationData
- **networkResults** `Object` — Output from the setupNetworkInterception getter
- **sections** `Array` — Extracted sections array
- **renderedDOM** `Array` — Rendered DOM elements array

- **Returns:** `Object` Analyzed animation profile

##### `groupAnimationsBySection(gsapCalls, lottieElements, cssKeyframes, sections)` <sub>line 629</sub>

Groups captured GSAP calls, Lottie elements, and CSS keyframes by section.

- **gsapCalls** `Array` — Merged GSAP calls (runtime + static)
- **lottieElements** `Array` — Lottie player positions from extractAnimationData
- **cssKeyframes** `Array` — CSS keyframe rules with bodies
- **sections** `Array` — Section boundary rects from page extraction

- **Returns:** `Object` Per-section animation data keyed by section index

---

### animation-injector.js (957 lines)

**Exports:** `buildAnimationContext`, `buildAllAnimationContexts`, `loadRegistry`

#### Exported Functions

##### `loadRegistry()` <sub>line 37</sub>

Load and cache the animation component registry.

- **Returns:** `Object` The registry object with component definitions

##### `buildAnimationContext(animationAnalysis, presetContent, sectionArchetype, sectionIndex, usedPatterns)` <sub>line 673</sub>

Build the animation context block for a single section.

- **animationAnalysis** `Object|null` — * @param {string} presetContent
- **sectionArchetype** `string` — * @param {number} sectionIndex

- **Returns:** `{ animationContext: string, tokenBudget: number, dependencies: string[], componentFiles: string[], selectedPattern: string|null ` }

##### `buildAllAnimationContexts(animationAnalysis, presetContent, sections)` <sub>line 923</sub>

Build animation context blocks for all sections.

- **animationAnalysis** `Object|null` — * @param {string} presetContent

- **Returns:** `{ contexts: Object, allComponentFiles: string[], allDependencies: string[] ` }

#### Internal Functions

- `lookupComponent(patternName)` <sub>line 57</sub>
- `readComponentSource(relativePath)` <sub>line 70</sub>
- `mapExtractedToPattern(sectionData)` <sub>line 90</sub>
- `extractPropOverrides(sectionData, componentDef)` <sub>line 184</sub>
- `selectAnimation(archetype, presetIntensity, engine, usedPatterns)` <sub>line 270</sub>
- `parsePresetIntensity(presetContent)` <sub>line 417</sub>
- `detectEngine(presetContent)` <sub>line 427</sub>
- `parseSectionOverrides(presetContent)` <sub>line 439</sub>
- `resolvePatterns(archetype, overrides)` <sub>line 462</sub>
- `getIntensity(animationAnalysis)` <sub>line 482</sub>
- `checkLottie(animationAnalysis, archetype, overridePattern)` <sub>line 494</sub>
- `calculateTokenBudget(patterns, engine, isLottie, hasComponentSource)` <sub>line 523</sub>
- `buildDependencies(engine, isLottie, componentDef)` <sub>line 546</sub>
- `buildComponentContext(componentDef, source, propOverrides, patternName)` <sub>line 578</sub>
- `buildLottieBlock(lottieInfo)` <sub>line 639</sub>

---

### animation-summarizer.js (210 lines)

**Called by:** animation-injector.js

**Exports:** `summarizeSection`, `summarizeAll`

#### Exported Functions

##### `summarizeSection(sectionData, engine)` <sub>line 80</sub>

Summarize animation data for a single section into a token-efficient text block.

- **sectionData** `Object` — Per-section data from groupAnimationsBySection
- **engine** `string` — Animation engine ('gsap', 'framer-motion', 'css')

- **Returns:** `string` Summarized text block, capped at ~800 tokens

##### `summarizeAll(perSection, engine)` <sub>line 196</sub>

Summarize animation data for all sections.

- **perSection** `Object` — Per-section data from groupAnimationsBySection
- **engine** `string` — Animation engine

- **Returns:** `Object<string, string>` Map of section index to summary text

#### Internal Functions

- `formatAnimationCall(anim)` <sub>line 23</sub>
- `formatScrollTrigger(st)` <sub>line 57</sub>

---

### archetype-mapper.js (270 lines)

**Called by:** url-to-preset.js

**Exports:** `mapSectionsToArchetypes`, `loadArchetypes`

#### Exported Functions

##### `loadArchetypes()` <sub>line 18</sub>

##### `mapSectionsToArchetypes(sections, textContent)` <sub>line 153</sub>

Map extracted sections to taxonomy archetypes.

- **sections** `object[]` — Sections from extractReference().sections
- **textContent** `object[]` — Text content from extractReference().textContent

- **Returns:** `object[]` Mapped sections with archetype, variant, confidence, and original data

#### Internal Functions

- `selectVariant(archetype, section, archetypes)` <sub>line 86</sub>

---

### asset-downloader.js (258 lines)

**Exports:** `verifyAssets`, `downloadAssets`

#### Exported Functions

##### `verifyAssets(downloadManifest)` <sub>line 135</sub>

Verify which assets from the download manifest are accessible.

- **Returns:** `Promise<Array<{ url: string, localPath: string, category: string ` >>} Filtered manifest

##### `downloadAssets(verifiedManifest, siteDir)` <sub>line 202</sub>

Download assets to the site's public directory.

- **siteDir** `string` — Absolute path to the site output directory

- **Returns:** `Promise<object>` Asset manifest mapping original URLs to local paths

#### Internal Functions

- `getTransport(url)` <sub>line 51</sub>
- `request(url, method, timeout)` <sub>line 63</sub>
- `ensureDir(dir)` <sub>line 113</sub>

---

### asset-injector.js (379 lines)

**Exports:** `categorizeImages`, `buildAssetContext`, `buildAllAssetContexts`, `getDownloadManifest`

#### Exported Functions

##### `categorizeImages(extractionData)` <sub>line 147</sub>

Categorize all images from extraction data into one of 10 categories.

- **extractionData** `object` — Full extraction result from extractReference()

- **Returns:** `Array<{ url: string, alt: string, width: number, height: number, category: string, sectionIndex: number ` >}

##### `buildAssetContext(categorizedImages, sectionArchetype, sectionIndex)` <sub>line 267</sub>

Build an asset context text block for a specific section.

- **categorizedImages** `Array` — Output from categorizeImages()
- **sectionArchetype** `string` — The section archetype (e.g. "HERO", "ABOUT")
- **sectionIndex** `number` — Index of the section

- **Returns:** `string` Formatted asset context block, or empty string if no matches

##### `buildAllAssetContexts(extractionData, sections)` <sub>line 322</sub>

Build asset contexts for all sections.

- **extractionData** `object` — Full extraction result from extractReference()

- **Returns:** `object` Map of section index to { assetContext: string, downloadManifest: Array }

##### `getDownloadManifest(categorizedImages)` <sub>line 360</sub>

Get a download manifest for all categorized images.

- **categorizedImages** `Array` — Output from categorizeImages()

- **Returns:** `Array<{ url: string, localPath: string, category: string ` >}

#### Internal Functions

- `buildLocalPath(url)` <sub>line 79</sub>
- `extractUrlFromBgImage(bgValue)` <sub>line 111</sub>
- `shouldFilter(src)` <sub>line 123</sub>

---

### design-tokens.js (266 lines)

**Called by:** enrich-preset.js, url-to-preset.js

**Exports:** `collectTokens`, `collectAnimationTokens`, `compareToPreset`, `parsePreset`, `rgbToHex`

#### Exported Functions

##### `rgbToHex(rgb)` <sub>line 10</sub>

##### `collectTokens(extractionData)` <sub>line 21</sub>

##### `collectAnimationTokens(extractionData)` <sub>line 97</sub>

Collects animation-specific design tokens from extraction data.

- **extractionData** `Object` — Full extraction result from extract-reference

- **Returns:** `Object` Animation tokens

##### `parsePreset(presetPath)` <sub>line 144</sub>

##### `compareToPreset(tokens, presetPath)` <sub>line 188</sub>

---

### extract-reference.js (577 lines)

**Called by:** enrich-preset.js, url-to-brief.js, url-to-preset.js

**Exports:** `extractReference`

#### Exported Functions

##### `extractReference(url, outputDir)` <sub>line 122</sub>

Extract visual and structural data from a reference website URL.

- **url** `string` — The fully-qualified URL to extract from.

- **Returns:** `Promise<ExtractionResult>` Structured extraction data.

#### Internal Functions

- `sleep(ms)` <sub>line 87</sub>
- `ensureDir(dir)` <sub>line 95</sub>

---

### gsap-extractor.js (455 lines)

**Called by:** extract-reference.js

**Exports:** `extractGsapFromBundles`, `mergeGsapData`

#### Exported Functions

##### `extractGsapFromBundles(bundleUrls)` <sub>line 378</sub>

Download JS bundles from captured network URLs and extract GSAP animation

- **bundleUrls** `string[]` — Array of JS bundle URLs (from network interception)

- **Returns:** `Promise<{calls: Array, bundlesAnalyzed: number, totalCalls: number` >}

##### `mergeGsapData(staticCalls, runtimeCalls)` <sub>line 429</sub>

Merge GSAP data from static bundle analysis and runtime interception.

- **staticCalls** `Array` — Calls extracted from JS bundles (this module)
- **runtimeCalls** `Array` — Calls captured at runtime (animation-detector.js)

- **Returns:** `Array` Merged and deduplicated call records

#### Internal Functions

- `downloadBundle(url)` <sub>line 32</sub>
- `extractBalancedBraces(str, startIndex)` <sub>line 104</sub>
- `parseGsapVars(varsStr)` <sub>line 162</sub>
- `extractGsapCalls(jsContent)` <sub>line 244</sub>

---

### post-process.js (314 lines)

**Exports:** `cleanComponent`, `validateComponent`, `processAllSections`

#### Exported Functions

##### `cleanComponent(rawCode, componentName)` <sub>line 47</sub>

Takes raw Claude output and cleans it into a valid .tsx file.

- **rawCode** `string` — The raw text produced by the LLM.
- **componentName** `string` — PascalCase component name (e.g. "HeroSection").

- **Returns:** `string` Cleaned source code.

##### `validateComponent(code, componentName)` <sub>line 116</sub>

Static validation of a component source string (no execution).

- **code** `string` — The cleaned component source.
- **componentName** `string` — Expected component name.

- **Returns:** `{ valid: boolean, warnings: string[], errors: string[] ` }

##### `processAllSections(sectionsDir)` <sub>line 201</sub>

Scan a directory for .tsx files, run cleanComponent + validateComponent on

- **sectionsDir** `string` — Absolute path to the sections directory.

- **Returns:** `Promise<{ processed: number, modified: number, issues: Array<{file: string, errors: string[], warnings: string[]` > }>}

#### Internal Functions

- `hasDefaultExport(code)` <sub>line 280</sub>
- `escapeRegExp(str)` <sub>line 288</sub>
- `stripStringsAndComments(code)` <sub>line 296</sub>

---

### section-context.js (193 lines)

**Exports:** `buildSectionContext`, `buildAllSectionContexts`

#### Exported Functions

##### `buildSectionContext(extractionData, sectionIndex, mappedSection)` <sub>line 17</sub>

Build a reference context block for a specific section.

- **extractionData** `object` — Full extraction result from extractReference()
- **sectionIndex** `number` — Index of the section in extractionData.sections
- **mappedSection** `object` — Output from archetype-mapper for this section

- **Returns:** `string` Formatted context block for the section prompt

##### `buildAllSectionContexts(extractionData, mappedSections)` <sub>line 182</sub>

Build context blocks for all sections.

- **extractionData** `object` — Full extraction result
- **mappedSections** `object[]` — Output from mapSectionsToArchetypes()

- **Returns:** `object` Map of section index to context string

---

### visual-validator.js (402 lines)

**Called by:** validate-build.js

**Exports:** `validateBuild`

#### Exported Functions

##### `validateBuild(projectDir, referenceScreenshots, options = {})` <sub>line 286</sub>

Validate a generated Next.js build against reference section screenshots.

- **projectDir** `string` — Path to the generated Next.js project
- **referenceScreenshots** `string[]` — Paths to reference section screenshots (ordered)

- **Returns:** `Promise<object>` Validation report

#### Internal Functions

- `waitForServer(port, timeoutMs = SERVER_STARTUP_TIMEOUT_MS)` <sub>line 25</sub>
- `startDevServer(projectDir, port)` <sub>line 65</sub>
- `killProcess(child)` <sub>line 103</sub>
- `computeDiff(originalPath, generatedPath, diffOutputPath)` <sub>line 123</sub>

---

## Top-Level Scripts (`scripts/quality/`)

### enrich-preset.js (162 lines)

#### Internal Functions

- `parseArgs()` <sub>line 19</sub>
- `printUsage()` <sub>line 31</sub>
- `nameToUrl(name)` <sub>line 44</sub>
- `aggregateTokens(allTokens)` <sub>line 56</sub>
- `generateReport(presetName, aggregated, comparison, analyzed, failed)` <sub>line 76</sub>
- `main()` <sub>line 97</sub>

---

### test-animation-detector.js (197 lines)

#### Internal Functions

- `sleep(ms)` <sub>line 29</sub>
- `testUrl(url)` <sub>line 33</sub>
- `main()` <sub>line 147</sub>

---

### url-to-brief.js (202 lines)

#### Internal Functions

- `parseArgs()` <sub>line 31</sub>
- `generateBrief(url, extractionData, projectName)` <sub>line 59</sub>
- `main()` <sub>line 158</sub>

---

### url-to-preset.js (276 lines)

#### Internal Functions

- `parseArgs()` <sub>line 34</sub>
- `hexToTailwindApprox(hex)` <sub>line 65</sub>
- `generatePreset(url, tokens, mappedSections, extractionData, animationAnalysis, animationTokens)` <sub>line 88</sub>
- `main()` <sub>line 193</sub>

---

### validate-build.js (288 lines)

#### Internal Functions

- `printUsage()` <sub>line 12</sub>
- `parseArgs(argv)` <sub>line 24</sub>
- `discoverScreenshots(dir)` <sub>line 94</sub>
- `autoDetectReferences(projectDir)` <sub>line 113</sub>
- `formatReport(report)` <sub>line 140</sub>
- `buildProgressBar(ratio, length)` <sub>line 202</sub>
- `main()` <sub>line 214</sub>

---
